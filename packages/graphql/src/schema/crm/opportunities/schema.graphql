enum OpportunityStage {
	PROSPECTING
	QUALIFICATION
	NEED_ANALYSIS
	DEMO
	PROPOSAL
	NEGOTIATION
	CLOSED_WON
	CLOSED_LOST
}

enum OpportunitySource {
	WEBSITE
	REFERRAL
	SOCIAL_MEDIA
	EMAIL_CAMPAIGN
	COLD_CALL
	EVENT
	ADVERTISMENT
	PARTNER
	EXISTING_CUSTOMER
	OTHER
}

type Opportunities {
	id: ID!
	name: String!
	stage: OpportunityStage
	dealValue: Float
	probability: Float
	expectedCloseDate: Date
	lostReason: String
	source: OpportunitySource
	owner: User
	contact: Contacts
	company: Companies
	campaign: Campaigns
	createdAt: Date
	updatedAt: Date
	products: [OpportunityProducts!]
	salesOrders: [SalesOrders!]
}

type StageCount {
	stage: String!
	count: Int!
}

type StageRevenue {
	stage: String!
	revenue: Float!
}

type OpportunitiesAnalytics {
	countByStage: [StageCount!]!
	totalRevenueByStage: [StageRevenue!]!
	winRate: Float!
	averageDealSize: Float!
}

extend type CrmQuery {
	opportunities(
		page: Int
		perPage: Int
		from: Date
		to: Date
		search: String
		stage: OpportunityStage
		source: OpportunitySource
		amountMin: Float
		amountMax: Float
		closeDateFrom: Date
		closeDateTo: Date
		companyId: ID
		ownerId: ID
		sortBy: String
		sortDirection: String
	): [Opportunities!]!
	opportunity(id: ID!): Opportunities!
	opportunitiesAnalytics: OpportunitiesAnalytics!
}

input CreateOpportunityInput {
	name: String! @constraint(minLength: 1)
	stage: OpportunityStage!
	dealValue: Float @constraint(min: 0)
	probability: Float @constraint(min: 0, max: 100)
	expectedCloseDate: Date
	lostReason: String @constraint(minLength: 1)
	source: OpportunitySource!
	ownerId: ID!
	contactId: ID
	companyId: ID
	campaignId: ID
	products: [CreateOpportunityProductInput!]!
}

input UpdateOpportunityInput {
	name: String @constraint(minLength: 1)
	stage: OpportunityStage
	dealValue: Float @constraint(min: 0)
	probability: Float @constraint(min: 0, max: 100)
	expectedCloseDate: Date
	lostReason: String @constraint(minLength: 1)
	source: OpportunitySource
}

extend type CrmMutation {
	createOpportunity(value: CreateOpportunityInput!): Opportunities!
	updateOpportunity(id: ID!, value: UpdateOpportunityInput!): Opportunities!
}

type CrmOpportunityStageChangedEvent {
	id: ID!
	newStage: OpportunityStage!
	previousStage: OpportunityStage!
	probability: Float
}

extend type Subscription {
	opportunityStageChanged: CrmOpportunityStageChangedEvent!
	opportunityWon: Opportunities!
	opportunityLost: Opportunities!
}
