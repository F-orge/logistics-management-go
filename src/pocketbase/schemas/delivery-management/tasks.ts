/**
 * Auto-generated Zod schema for DeliveryManagementTasks
 * Generated by: scripts/generate-zod-schemas.ts
 * DO NOT EDIT MANUALLY
 */

import { z } from "zod";
import { Collections } from "@/lib/pb.types";

export const TasksSchema = z
  .object({
    id: z.string(),
    package: z.string(),
    route: z.string(),
    sequence: z.number().min(1, "Sequence must be at least 1"),
    deliveryAddress: z.string(),
    recipientName: z.string().optional(),
    recipientPhone: z.string().optional(),
    deliveryInstructions: z.string().optional(),
    estimatedArrivalTime: z.iso.date().optional(),
    actualArrivalTime: z.iso.date().optional(),
    deliveryTime: z.iso.date().optional(),
    status: z
      .enum([
        "pending",
        "assigned",
        "out-for-delivery",
        "delivered",
        "failed",
        "cancelled",
        "rescheduled",
      ])
      .optional(),
    attempCount: z
      .number()
      .min(0, "Attempt count must be non-negative")
      .optional(),
    attachments: z.file().array().optional(),
    failureReason: z
      .enum([
        "recipient-not-home",
        "address-not-found",
        "refused-delivery",
        "damaged-package",
        "access-denied",
        "weather-conditions",
        "vehicle-breakdown",
        "other",
      ])
      .optional(),
    created: z.iso.datetime().optional(),
    updated: z.iso.datetime().optional(),
  })
  .superRefine((data, ctx) => {
    // State Machine Constraint: Status follows lifecycle
    // pending -> assigned -> out-for-delivery -> (delivered | failed)
    // Terminal states: delivered, failed, cancelled
    const terminalStatuses = ["delivered", "failed", "cancelled"];

    if (data.status && terminalStatuses.includes(data.status)) {
      ctx.addIssue({
        code: "custom",
        message: `Delivery task with status '${data.status}' is in a terminal state and cannot be modified`,
      });
    }

    // POD Requirement: Transition to 'Delivered' is conditional on POD record creation
    if (data.status === "delivered") {
      console.info(
        "ðŸ“‹ POD Requirement: Delivery task can only transition to 'delivered' after proof_of_deliveries record is created"
      );
    }

    // Constraint: If status is Failed, failureReason must be populated
    if (data.status === "failed" && !data.failureReason) {
      ctx.addIssue({
        code: "custom",
        path: ["failureReason"],
        message: "Failure reason is required when delivery status is 'failed'",
      });
    }

    // Trigger: When status is updated to 'out-for-delivery', generate customer tracking link
    if (data.status === "out-for-delivery") {
      console.info(
        "ðŸ”„ Trigger: customer_tracking_links record should be generated when delivery task moves to 'out-for-delivery'"
      );
    }
  });

export type Tasks = z.infer<typeof TasksSchema>;
