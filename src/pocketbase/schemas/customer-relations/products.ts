/**
 * Auto-generated Zod schema for CustomerRelationsProducts
 * Generated by: scripts/generate-zod-schemas.ts
 * DO NOT EDIT MANUALLY
 */

import { ClientResponseError } from "pocketbase";
import { z } from "zod";
import {
  Collections,
  CustomerRelationsProductsRecord,
  TypedPocketBase,
} from "@/lib/pb.types";

export const ProductsSchema = z.object({
  id: z.string(),
  name: z.string().nonempty("Product name is required"),
  sku: z.string().nonempty("SKU is required"),
  price: z.number().min(0, "Price must be a positive value or zero"),
  type: z.enum(["service", "good", "digital", "subscription"]),
  description: z.unknown().optional(),
  attachments: z.file().array().optional(),
  created: z.iso.datetime().optional(),
  updated: z.iso.datetime().optional(),
});

export type Products = z.infer<typeof ProductsSchema>;

export const CreateProductsSchema = (pocketbase: TypedPocketBase) =>
  ProductsSchema.omit({
    id: true,
    created: true,
    updated: true,
  }).superRefine(async (data, ctx) => {
    // Unique constraint: SKU must be unique
    if (data.sku) {
      try {
        const existingProduct = await pocketbase
          .collection(Collections.CustomerRelationsProducts)
          .getFirstListItem(`sku = "${data.sku.replace(/"/g, '\\"')}"`, {
            requestKey: null,
          });

        if (existingProduct) {
          ctx.addIssue({
            code: "custom",
            path: ["sku"],
            message: `SKU "${data.sku}" is already in use`,
          });
        }
      } catch (error) {
        // Record not found is expected - SKU is unique
        if (!(error instanceof ClientResponseError) || error.status !== 404) {
          // Log unexpected errors but don't fail validation
          console.warn("SKU uniqueness check error:", error);
        }
      }
    }
  });

export const UpdateProductsSchema = (
  pocketbase: TypedPocketBase,
  record?: CustomerRelationsProductsRecord
) =>
  ProductsSchema.partial()
    .omit({
      id: true,
      created: true,
      updated: true,
      attachments: true,
    })
    .superRefine(async (data, ctx) => {
      // Unique constraint: SKU must be unique (when being updated)
      if (data.sku) {
        try {
          const existingProduct = await pocketbase
            .collection(Collections.CustomerRelationsProducts)
            .getFirstListItem(`sku = "${data.sku.replace(/"/g, '\\"')}"`, {
              requestKey: null,
            });

          // If found, check if it's a different record (not the one being updated)
          if (existingProduct && existingProduct.id !== record?.id) {
            ctx.addIssue({
              code: "custom",
              path: ["sku"],
              message: `SKU "${data.sku}" is already in use`,
            });
          }
        } catch (error) {
          // Record not found is expected - SKU is unique
          if (!(error instanceof ClientResponseError) || error.status !== 404) {
            console.warn("SKU uniqueness check error:", error);
          }
        }
      }
    });
