/**
 * Auto-generated Zod schema for CustomerRelationsCases
 * Generated by: scripts/generate-zod-schemas.ts
 * DO NOT EDIT MANUALLY
 */

import { ClientResponseError } from "pocketbase";
import { z } from "zod";
import {
  Collections,
  CustomerRelationsCasesRecord,
  TypedPocketBase,
} from "@/lib/pb.types";

export const CasesSchema = z.object({
  id: z.string(),
  caseNumber: z
    .string("Case number is required")
    .nonempty("Case number is required"),
  status: z
    .enum([
      "new",
      "in-progress",
      "waiting-for-customer",
      "waiting-for-internal",
      "escalated",
      "resolved",
      "closed",
      "cancelled",
    ])
    .describe("Case status is required"),
  priority: z
    .enum(["critical", "high", "medium", "low"])
    .describe("Priority level is required"),
  type: z.enum([
    "question",
    "problem",
    "complaint",
    "feature-request",
    "bug-report",
    "technical-support",
  ]),
  owner: z.string(),
  contact: z.string().optional(),
  description: z.unknown().optional(),
  attachments: z.file().array().optional(),
  created: z.iso.datetime().optional(),
  updated: z.iso.datetime().optional(),
});

export type Cases = z.infer<typeof CasesSchema>;

export const CreateCasesSchema = (pocketbase: TypedPocketBase) =>
  CasesSchema.omit({
    id: true,
    created: true,
    updated: true,
  }).superRefine(async (data, ctx) => {
    // Validate case number is provided and unique
    if (!data.caseNumber || data.caseNumber.trim().length === 0) {
      ctx.addIssue({
        code: "custom",
        path: ["caseNumber"],
        message: "Case number is required",
      });
      return;
    }

    // Unique constraint: Case number must be unique
    try {
      const existingCase = await pocketbase
        .collection(Collections.CustomerRelationsCases)
        .getFirstListItem(
          `caseNumber = "${data.caseNumber.replace(/"/g, '\\"')}"`,
          { requestKey: null }
        );

      if (existingCase) {
        ctx.addIssue({
          code: "custom",
          path: ["caseNumber"],
          message: `Case number "${data.caseNumber}" is already in use. please reload the page to get the latest case number`,
        });
      }
    } catch (error) {
      // Record not found is expected - case number is unique
      if (!(error instanceof ClientResponseError) || error.status !== 404) {
        console.warn("Case number uniqueness check error:", error);
      }
    }

    // New cases should start with "new" status
    if (data.status && data.status !== "new") {
      ctx.addIssue({
        code: "custom",
        path: ["status"],
        message: "New cases must start with 'new' status",
      });
    }
  });

export const UpdateCasesSchema = (
  pocketbase: TypedPocketBase,
  record?: CustomerRelationsCasesRecord
) =>
  CasesSchema.partial()
    .omit({
      id: true,
      created: true,
      updated: true,
      attachments: true,
    })
    .superRefine(async (data, ctx) => {
      // Get current case status from existing record
      const currentStatus = record?.status;
      const newStatus = data.status;

      // Prevent modification if case is already in a terminal state
      if (currentStatus === "closed" || currentStatus === "cancelled") {
        ctx.addIssue({
          code: "custom",
          path: ["status"],
          message: `Cases in '${currentStatus}' status cannot be modified`,
        });
        return;
      }

      // Validate status transitions using state machine rules
      if (newStatus && currentStatus) {
        const validTransitions: Record<string, string[]> = {
          new: [
            "in-progress",
            "waiting-for-customer",
            "waiting-for-internal",
            "escalated",
            "cancelled",
          ],
          "in-progress": [
            "waiting-for-customer",
            "waiting-for-internal",
            "escalated",
            "resolved",
            "cancelled",
          ],
          "waiting-for-customer": [
            "in-progress",
            "escalated",
            "resolved",
            "cancelled",
          ],
          "waiting-for-internal": [
            "in-progress",
            "escalated",
            "resolved",
            "cancelled",
          ],
          escalated: [
            "in-progress",
            "waiting-for-customer",
            "waiting-for-internal",
            "resolved",
            "cancelled",
          ],
          resolved: ["closed"],
        };

        const allowedTransitions = validTransitions[currentStatus] || [];

        if (!allowedTransitions.includes(newStatus)) {
          ctx.addIssue({
            code: "custom",
            path: ["status"],
            message: `Cannot transition from '${currentStatus}' to '${newStatus}'. Valid transitions: ${allowedTransitions.join(", ")}`,
          });
        }
      }

      // Validate case number is not empty if being updated
      if (
        data.caseNumber !== undefined &&
        data.caseNumber.trim().length === 0
      ) {
        ctx.addIssue({
          code: "custom",
          path: ["caseNumber"],
          message: "Case number cannot be empty",
        });
        return;
      }

      // Unique constraint: Case number must be unique (when being updated)
      if (data.caseNumber) {
        try {
          // Check if another case with the same case number exists
          const existingCase = await pocketbase
            .collection(Collections.CustomerRelationsCases)
            .getFirstListItem(
              `caseNumber = "${data.caseNumber.replace(/"/g, '\\"')}"`,
              { requestKey: null }
            );

          // If found, check if it's a different record (not the one being updated)
          if (existingCase && existingCase.id !== record?.id) {
            ctx.addIssue({
              code: "custom",
              path: ["caseNumber"],
              message: `Case number "${data.caseNumber}" is already in use`,
            });
          }
        } catch (error) {
          // Record not found is expected - case number is unique
          if (!(error instanceof ClientResponseError) || error.status !== 404) {
            console.warn("Case number uniqueness check error:", error);
          }
        }
      }
    });
